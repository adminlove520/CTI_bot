name: Update RSS Feeds

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual trigger
    inputs:
      reason:
        description: 'Reason for manual run'
        required: false
        default: 'Manual update'

jobs:
  update_rss:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Update feeds from OPML sources
        run: |
          python3 opml_to_rss.py

      - name: Check and remove invalid feeds
        run: |
          python3 checkFeed.py --remove-invalid

      - name: Generate commit message
        id: commit_msg
        run: |
          # Check if commit_message.txt exists (generated by checkFeed.py)
          if [ -f "commit_message.txt" ]; then
            COMMIT_MSG=$(cat commit_message.txt)
          else
            # Check if there are any changes
            git diff --quiet || git diff --staged --quiet
            if [ $? -ne 0 ]; then
              COMMIT_MSG="Update RSS feeds: no invalid feeds removed, but OPML sources updated"
            else
              COMMIT_MSG="Update RSS feeds: no changes"
            fi
          fi
          # Use multiline output format to handle commit messages with newlines
          echo "commit_message<<EOF" >> $GITHUB_OUTPUT
          echo "$COMMIT_MSG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        run: |
          set -x  # Enable debug mode to see each command
          set -e  # Exit immediately if any command fails
          
          # Debug: Check current directory and git status
          echo "Current directory: $(pwd)"
          echo "Directory contents:"
          ls -la
          
          # Check git repository status
          echo "Git repository status:"
          git status
          
          # Check if git is installed and its version
          echo "Git version:"
          git --version
          
          # Check git user configuration (without --global to avoid permission issues)
          echo "Configuring git user..."
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git config user.name "GitHub Actions Bot"
          
          # Debug: Check git config (local)
          echo "Git config (local):"
          git config --list
          
          # Check git remote configuration
          echo "Git remote:"
          git remote -v
          
          # Check git branch
          echo "Git branch:"
          git branch
          
          # Add changes with explicit path
          git add .
          
          # Check if there are any changes to commit
          echo "Checking for staged changes..."
          git diff --staged --quiet
          if [ $? -ne 0 ]; then
            echo "Creating commit..."
            git commit -m "${{ steps.commit_msg.outputs.commit_message }}"
            echo "Pushing changes..."
            git push
          else
            echo "No changes to commit"
          fi
