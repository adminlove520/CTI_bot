name: Update RSS Feeds

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual trigger
    inputs:
      reason:
        description: 'Reason for manual run'
        required: false
        default: 'Manual update'

jobs:
  update_rss:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Update feeds from OPML sources
        run: |
          python3 opml_to_rss.py

      - name: Check and remove invalid feeds
        run: |
          python3 checkFeed.py --remove-invalid

      - name: Generate commit message
        id: commit_msg
        run: |
          # Check if commit_message.txt exists (generated by checkFeed.py)
          if [ -f "commit_message.txt" ]; then
            COMMIT_MSG=$(cat commit_message.txt)
          else
            # Check if there are any changes
            git diff --quiet || git diff --staged --quiet
            if [ $? -ne 0 ]; then
              COMMIT_MSG="Update RSS feeds: no invalid feeds removed, but OPML sources updated"
            else
              COMMIT_MSG="Update RSS feeds: no changes"
            fi
          fi
          echo "commit_message=$COMMIT_MSG" >> $GITHUB_OUTPUT

      - name: Commit and push changes
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "GitHub Actions Bot"
          
          git add .
          
          # Check if there are any changes to commit
          git diff --staged --quiet
          if [ $? -ne 0 ]; then
            git commit -m "${{ steps.commit_msg.outputs.commit_message }}"
            git push
          else
            echo "No changes to commit"
          fi
